<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${isEdit} ? 'Edit Client' : 'Add Client'">Client</title>
  <link rel="stylesheet" href="/webjars/bootstrap/5.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/app-theme.css">
</head>
<body class="auth-bg">
<div class="center-card">
  <h4 class="brand-title mb-3" th:text="${isEdit} ? 'Edit Client' : 'Add Client'"></h4>

  <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

  <form id="clientForm"
        th:action="@{${isEdit} ? '/admin/clients/' + ${client.id} : '/admin/clients'}"
        th:object="${client}" method="post" autocomplete="off">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

    <div class="mb-3">
      <label class="form-label">Client ID</label>
      <input id="clientId" class="form-control" th:field="*{clientId}"
             th:readonly="${isEdit}" th:attr="aria-readonly=${isEdit}" required autocomplete="off"/>
      <div class="text-danger" th:if="${#fields.hasErrors('clientId')}" th:errors="*{clientId}"></div>
      <div id="clientIdError" class="text-danger"></div>
    </div>

    <div class="mb-3">
      <label class="form-label">Client Name</label>
      <input id="clientName" class="form-control" th:field="*{clientName}" required autocomplete="off">
      <div id="clientNameError" class="text-danger"></div>
    </div>

    <div class="mb-3">
      <label class="form-label">Subscription Name</label>
      <input id="subscriptionName" class="form-control" th:field="*{subscriptionName}" required autocomplete="off">
      <div id="subscriptionNameError" class="text-danger"></div>
    </div>

    <div class="mb-3">
      <label class="form-label">Contact Name</label>
      <input id="contactName" class="form-control" th:field="*{contactName}" required autocomplete="off">
      <div id="contactNameError" class="text-danger"></div>
    </div>

    <div class="mb-3">
      <label class="form-label">Contact Email</label>
      <input id="contactEmail" class="form-control" th:field="*{contactEmail}" required autocomplete="off">
      <div id="contactEmailError" class="text-danger"></div>
    </div>

    <div class="d-flex gap-2">
      <button id="saveBtn" type="submit" class="btn btn-primary" disabled>Save</button>
      <a class="btn btn-outline-secondary" th:href="@{/admin}">Cancel</a>
    </div>
  </form>
</div>

<!-- Save Confirmation Modal -->
<div class="modal fade" id="saveConfirmModal" tabindex="-1" aria-labelledby="saveConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-3 shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="saveConfirmModalLabel">Confirm Save</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to save this client?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirmSaveBtn" class="btn btn-primary">Yes, Save</button>
      </div>
    </div>
  </div>
</div>

<script>
  function validateClient() {
    let valid = true;

    const clientId = document.getElementById('clientId');
    const clientName = document.getElementById('clientName');
    const subscriptionName = document.getElementById('subscriptionName');
    const contactName = document.getElementById('contactName');
    const contactEmail = document.getElementById('contactEmail');

    // Clear errors
    document.getElementById('clientIdError').innerText = '';
    document.getElementById('clientNameError').innerText = '';
    document.getElementById('subscriptionNameError').innerText = '';
    document.getElementById('contactNameError').innerText = '';
    document.getElementById('contactEmailError').innerText = '';

    // Required checks
    if (!clientId.value.trim()) {
      document.getElementById('clientIdError').innerText = 'Client ID is required';
      valid = false;
    }
    if (!clientName.value.trim()) {
      document.getElementById('clientNameError').innerText = 'Client Name is required';
      valid = false;
    }
    if (!subscriptionName.value.trim()) {
      document.getElementById('subscriptionNameError').innerText = 'Subscription Name is required';
      valid = false;
    } else if (/\s/.test(subscriptionName.value)) {
      document.getElementById('subscriptionNameError').innerText = 'Subscription Name cannot contain spaces';
      valid = false;
    }
    if (!contactName.value.trim()) {
      document.getElementById('contactNameError').innerText = 'Contact Name is required';
      valid = false;
    }
    if (!contactEmail.value.trim()) {
      document.getElementById('contactEmailError').innerText = 'Contact Email is required';
      valid = false;
    } else {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(contactEmail.value)) {
        document.getElementById('contactEmailError').innerText = 'Invalid email format';
        valid = false;
      }
    }

    // Enable/disable save button
    document.getElementById('saveBtn').disabled = !valid;

    return valid;
  }

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('clientForm');
    const saveBtn = document.getElementById('saveBtn');
    const confirmSaveBtn = document.getElementById('confirmSaveBtn');

    const inputs = ['clientId', 'clientName', 'subscriptionName', 'contactName', 'contactEmail'];
    inputs.forEach(id => {
      document.getElementById(id).addEventListener('input', validateClient);
    });

    validateClient(); // initial validation

    // Intercept form submit
    form.addEventListener('submit', function (e) {
      if (!validateClient()) {
        e.preventDefault();
        return false;
      }
      e.preventDefault(); // stop immediate submit
      const modal = new bootstrap.Modal(document.getElementById('saveConfirmModal'));
      modal.show();

      confirmSaveBtn.onclick = function () {
        modal.hide();
        form.submit();
      };
    });
  });
</script>

<script src="/webjars/bootstrap/5.3.7/js/bootstrap.bundle.min.js"></script>
</body>
</html>
