<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin</title>
    <link rel="stylesheet" href="/webjars/bootstrap/5.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/app-theme.css">
    <style>
        .card-glass {
            border-radius: .5rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
        }

        th, td {
            vertical-align: middle !important;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-body-tertiary px-3">
    <a class="navbar-brand" href="#">Admin</a>
    <div class="ms-auto">
        <a class="btn btn-sm btn-outline-secondary me-2" href="/dashboard">Dashboard</a>
        <form th:action="@{/logout}" method="post" style="display:inline">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="btn btn-sm btn-outline-danger">Logout</button>
        </form>
    </div>
</nav>

<div class="container-fluid py-4"><!-- changed to full-width -->

    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <!-- USERS -->
    <div class="card card-glass mb-4 border rounded-3 shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center rounded-top">
            <h5 class="mb-0">Users</h5>
            <div class="d-flex">
                <button class="btn btn-outline-primary btn-sm me-2" data-bs-toggle="collapse"
                        data-bs-target="#usersTable">
                    Toggle
                </button>
                <a class="btn btn-primary btn-sm" th:href="@{/admin/users/new}">
                    <i class="fa fa-user-plus me-1"></i> Add User
                </a>
            </div>
        </div>
        <div id="usersTable" class="collapse show">
            <div class="card card-glass mb-4">
                <div class="card-body p-0">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-primary">
                        <tr>
                            <th style="width:80px;">ID</th>
                            <th>Username</th>
                            <th>Role</th>
                            <th style="width:320px;">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="u : ${users}">
                            <td th:text="${u.id}"></td>
                            <td th:text="${u.username}"></td>
                            <td th:text="${u.role}"></td>
                            <td>
                                <a class="btn btn-sm btn-outline-secondary"
                                   th:href="@{/admin/users/{id}/edit(id=${u.id})}">Edit</a>
                                <!-- Reset Password Button -->
                                <form th:action="@{/admin/users/{id}/reset-password(id=${u.id})}"
                                      method="post"
                                      class="resetForm"
                                      style="display:inline;">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-sm btn-outline-warning">Reset Password</button>
                                </form>


                                <form th:action="@{/admin/users/delete/{id}(id=${u.id})}" method="post"
                                      class="deleteForm" style="display:inline;">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                                </form>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(users)}">
                            <td colspan="4" class="text-muted text-center">No users yet.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Users pagination -->
            <nav th:if="${usersPage.totalPages > 1}" class="mb-4">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    <li class="page-item" th:classappend="${usersPage.first} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/admin(upage=${usersPage.number - 1}, cpage=${clientsPage.number})}">Prev</a>
                    </li>

                    <li class="page-item" th:each="i : ${#numbers.sequence(0, usersPage.totalPages - 1)}"
                        th:classappend="${i == usersPage.number} ? 'active'">
                        <a class="page-link" th:text="${i + 1}"
                           th:href="@{/admin(upage=${i}, cpage=${clientsPage.number})}"></a>
                    </li>

                    <li class="page-item" th:classappend="${usersPage.last} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/admin(upage=${usersPage.number + 1}, cpage=${clientsPage.number})}">Next</a>
                    </li>
                </ul>
            </nav>

        </div>
    </div>

    <!-- CLIENTS -->
    <div class="card card-glass mb-4 border rounded-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Clients</h5>
            <div class="d-flex">
                <button class="btn btn-outline-primary btn-sm me-2" data-bs-toggle="collapse"
                        data-bs-target="#clientsTable">
                    Toggle
                </button>
                <a class="btn btn-primary btn-sm" th:href="@{/admin/clients/new}">
                    <i class="fa fa-user-gear me-1"></i> Add Client
                </a>
            </div>
        </div>
        <div id="clientsTable" class="collapse show">
            <div class="card card-glass mb-4">
                <div class="card-body p-0">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-secondary">
                        <tr>
                            <th style="width:80px;">ID</th>
                            <th>Client ID</th>
                            <th>Name</th>
                            <th>Display</th>
                            <th>Group</th>
                            <th style="width:220px;">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="c : ${clients}">
                            <td th:text="${c.id}"></td>
                            <td th:text="${c.clientId}"></td>
                            <td th:text="${c.name}"></td>
                            <td th:text="${c.displayName}"></td>
                            <td th:text="${c.consumerGroupName}"></td>
                            <td>
                                <a class="btn btn-sm btn-outline-secondary"
                                   th:href="@{/admin/clients/{id}/edit(id=${c.id})}">Edit</a>
                                <form th:action="@{/admin/clients/delete/{id}(id=${c.id})}" method="post"
                                      class="deleteForm" style="display:inline;">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                                </form>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(clients)}">
                            <td colspan="6" class="text-muted text-center">No clients yet.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Clients pagination -->
            <nav th:if="${clientsPage.totalPages > 1}" class="mb-4">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    <li class="page-item" th:classappend="${clientsPage.first} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/admin(upage=${usersPage.number}, cpage=${clientsPage.number - 1})}">Prev</a>
                    </li>
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, clientsPage.totalPages - 1)}"
                        th:classappend="${i == clientsPage.number} ? 'active'">
                        <a class="page-link" th:text="${i + 1}"
                           th:href="@{/admin(upage=${usersPage.number}, cpage=${i})}"></a>
                    </li>
                    <li class="page-item" th:classappend="${clientsPage.last} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/admin(upage=${usersPage.number}, cpage=${clientsPage.number + 1})}">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this item? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Reset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to reset the password for this user?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmResetBtn" class="btn btn-warning">Reset Password</button>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        let targetDeleteForm = null;
        let targetResetForm = null;

        // Delete forms: existing behavior (keeps working)
        document.querySelectorAll(".deleteForm").forEach(form => {
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                targetDeleteForm = form;
                const modal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));
                modal.show();
            });
        });

        document.getElementById("confirmDeleteBtn").addEventListener("click", function () {
            if (targetDeleteForm) {
                targetDeleteForm.submit();
            }
        });

        // Reset forms: same pattern as delete
        document.querySelectorAll(".resetForm").forEach(form => {
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                targetResetForm = form;
                const modal = new bootstrap.Modal(document.getElementById("resetConfirmModal"));
                modal.show();
            });
        });

        document.getElementById("confirmResetBtn").addEventListener("click", function () {
            if (targetResetForm) {
                targetResetForm.submit();
            }
        });
    });
</script>

<script src="/webjars/bootstrap/5.3.7/js/bootstrap.bundle.min.js"></script>
</body>
</html>
